{% extends "base.html" %}

{% block title %}
    {% if agent %}
        Agent: {{ agent.hostname }}
    {% else %}
        IoT Security Dashboard
    {% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-container" data-agent-uuid="{{ agent.agent_uuid | default('') }}">
    <header class="dashboard-header mb-5 text-center">
        {% if agent %}
            <a href="/dashboard/agents" class="btn btn-sm btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left me-2"></i>Back to All Agents
            </a>
            <h1 class="gradient-title">Dashboard for: {{ agent.hostname }}</h1>
        {% else %}
            <h1 class="gradient-title">IoT Security Dashboard</h1>
        {% endif %}
        
        <p class="lead text-muted">A real-time overview of operational and security status.</p>
        <p class="text-muted small" id="last-update-text">Connecting to agent...</p>
    </header>

    <div class="row g-4 justify-content-center">
        <div class="col-md-6 col-lg-4">
            <a href="/dashboard/cpu#tabProcesses" class="text-decoration-none">
                <div class="themed-card dashboard-tile">
                    <div class="tile-icon icon-cpu"><i class="fas fa-microchip"></i></div>
                    <h5 class="tile-title">CPU & Processes</h5>
                    <p class="tile-desc">Top Process: <strong class="data-placeholder" id="top-process">Loading...</strong></p>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-4">
            <a href="/dashboard/sessions" class="text-decoration-none">
                <div class="themed-card dashboard-tile">
                    <div class="tile-icon icon-sessions"><i class="fas fa-users"></i></div>
                    <h5 class="tile-title">Login Sessions</h5>
                    <p class="tile-desc"><strong class="data-placeholder" id="active-sessions">--</strong> Active Session(s)</p>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-4">
            <a href="/dashboard/command_history" class="text-decoration-none">
                <div class="themed-card dashboard-tile">
                    <div class="tile-icon icon-commands"><i class="fas fa-terminal"></i></div>
                    <h5 class="tile-title">Command History</h5>
                    <p class="tile-desc">Last Executed: <strong class="data-placeholder" id="last-command">Loading...</strong></p>
                </div>
            </a>
        </div>
         <div class="col-md-6 col-lg-4">
            <a href="/dashboard/file_integrity" class="text-decoration-none">
                <div class="themed-card dashboard-tile">
                    <div class="tile-icon icon-files"><i class="fas fa-shield-halved"></i></div>
                    <h5 class="tile-title">File Integrity</h5>
                    <p class="tile-desc"><strong class="data-placeholder" id="changed-files">--</strong> Files Changed Today</p>
                </div>
            </a>
        </div>
         <div class="col-md-6 col-lg-4">
            <a href="/dashboard/security" class="text-decoration-none">
                <div class="themed-card dashboard-tile">
                    <div class="tile-icon icon-security"><i class="fas fa-user-secret"></i></div>
                    <h5 class="tile-title">Security Events</h5>
                     <p class="tile-desc"><strong class="data-placeholder" id="failed-logins">--</strong> Failed Logins Today</p>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-4">
            <a href="/dashboard/cpu#tabAlerts" class="text-decoration-none">
                <div class="themed-card dashboard-tile">
                    <div class="tile-icon icon-audit"><i class="fas fa-bell"></i></div>
                    <h5 class="tile-title">System Alerts</h5>
                    <p class="tile-desc"><strong class="data-placeholder" id="audit-events">--</strong> Active Alerts</p>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    :root {
        --card-shadow: 0 0.5rem 1rem rgba(0,0,0,0.075);
        --card-hover-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.1);
    }
    .dark-mode {
        --card-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.25);
        --card-hover-shadow: 0 1rem 2rem rgba(0,0,0,0.3);
    }
    .dashboard-container { padding: 2rem; }
    .gradient-title { font-weight: 700; background: linear-gradient(90deg, #0d6efd, #6f42c1, #d63384); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .dark-mode .gradient-title { background: linear-gradient(90deg, #4facfe, #00f2fe, #43e97b); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .dashboard-header .lead { color: var(--text-muted-color); }
    .themed-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 1rem; padding: 2rem; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: var(--card-shadow); position: relative; overflow: hidden; }
    a .themed-card:hover { transform: translateY(-8px); box-shadow: var(--card-hover-shadow); border-color: var(--primary-color); }
    .dashboard-tile { display: flex; flex-direction: column; align-items: center; text-align: center; }
    .tile-icon { font-size: 2.5rem; width: 80px; height: 80px; border-radius: 50%; display: grid; place-items: center; margin-bottom: 1rem; transition: all 0.3s ease; }
    a .themed-card:hover .tile-icon { transform: scale(1.1) rotate(-5deg); }
    .tile-title { font-weight: 600; margin-bottom: 0.5rem; color: var(--text-color); }
    .tile-desc { font-size: 0.9em; color: var(--text-muted-color); }
    .icon-cpu { background-color: #e7f1ff; color: #0d6efd; } .icon-sessions { background-color: #dcfce7; color: #16a34a; } .icon-commands { background-color: #fffbe5; color: #f59e0b; } .icon-files { background-color: #fee2e2; color: #ef4444; } .icon-security { background-color: #eef2ff; color: #4f46e5; } .icon-audit { background-color: #e5e7eb; color: #4b5563; }
    .dark-mode .icon-cpu { background-color: rgba(77, 171, 247, 0.1); color: #4dabf7; } .dark-mode .icon-sessions { background-color: rgba(74, 222, 128, 0.1); color: #4ade80; } .dark-mode .icon-commands { background-color: rgba(255, 212, 59, 0.1); color: #ffd43b; } .dark-mode .icon-files { background-color: rgba(255, 107, 107, 0.1); color: #ff6b6b; } .dark-mode .icon-security { background-color: rgba(139, 92, 246, 0.1); color: #8b5cf6; } .dark-mode .icon-audit { background-color: rgba(107, 114, 128, 0.1); color: #6b7280; }
    .data-placeholder { display: inline-block; background-color: var(--text-muted-color); opacity: 0.2; border-radius: 4px; color: transparent; animation: pulse 1.5s infinite; min-width: 80px; }
    @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.3; } 100% { opacity: 0.2; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lastUpdateTime = null;
    const container = document.querySelector('.dashboard-container');
    const agentUUID = container.dataset.agentUuid;

    const fetchDashboardSummary = async () => {
        try {
            let apiUrl = '/api/v1/dashboard/summary';
            if (agentUUID) {
                apiUrl = `/api/v1/dashboard/summary/${agentUUID}`;
            }

            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error ${response.status}: ${errorText}`);
            }
            const data = await response.json();
            
            lastUpdateTime = new Date();

            updateTile('top-process', data.top_process);
            updateTile('active-sessions', data.active_sessions);
            updateTile('last-command', data.last_command);
            updateTile('changed-files', data.changed_files_count);
            updateTile('failed-logins', data.failed_logins_count);
            updateTile('audit-events', data.audit_events_count);

        } catch (error) {
            console.error("Error fetching dashboard summary:", error);
            document.querySelectorAll('.data-placeholder').forEach(el => {
                el.textContent = "Error";
                el.classList.remove('data-placeholder');
            });
        }
    };
    
    function updateTile(id, value) {
        const el = document.getElementById(id);
        if (el) { el.textContent = value; el.classList.remove('data-placeholder'); }
    }

    function updateTimestamp() {
        const el = document.getElementById('last-update-text');
        if (lastUpdateTime) {
            const secondsAgo = Math.round((new Date() - lastUpdateTime) / 1000);
            if (secondsAgo < 5) { el.textContent = "Last updated: just now"; }
            else if (secondsAgo < 60) { el.textContent = `Last updated: ${secondsAgo} seconds ago`; }
            else { el.textContent = `Last updated: ${Math.round(secondsAgo / 60)} minute(s) ago`; }
        }
    }

    fetchDashboardSummary();
    setInterval(fetchDashboardSummary, 30000); // Refresh every 30 seconds
    setInterval(updateTimestamp, 1000); // Update the 'last updated' text every second
});
</script>
{% endblock %}