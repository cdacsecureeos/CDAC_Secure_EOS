{% extends "base.html" %}

{% block title %}Dashboard: {{ agent.hostname }}{% endblock %}

{% block content %}
<div class="container-fluid p-4" id="agent-dashboard-container" data-agent-uuid="{{ agent.agent_uuid }}">
    <header class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <a href="/dashboard/agents" class="btn btn-sm btn-outline-secondary mb-2">
                <i class="fas fa-arrow-left me-2"></i>Back to All Agents
            </a>
            <h1 class="h2 text-nowrap">
                <i class="fas fa-desktop me-2"></i>Dashboard: {{ agent.hostname }}
            </h1>
        </div>
        <div>
            {% set status_color = 'success' if agent.status == 'Active' else ('warning' if agent.status == 'Disconnected' else 'danger') %}
            <span id="agent-status-badge" class="badge bg-{{ status_color }} p-2" style="font-size: 1rem;">
                <span id="agent-status-icon"></span>
                <span id="agent-status-text">{{ agent.status }}</span>
            </span>
        </div>
    </header>

    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="summary-card-small">
                <div class="card-icon icon-sessions"><i class="fas fa-users"></i></div>
                <div>
                    <h6 class="text-muted mb-0">Active Sessions</h6>
                    <p class="fs-2 fw-bold" id="active-sessions">--</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-card-small">
                <div class="card-icon icon-commands"><i class="fas fa-terminal"></i></div>
                <div>
                    <h6 class="text-muted mb-0">Last Command</h6>
                    <p class="fs-5 fw-bold" id="last-command">N/A</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-card-small">
                <div class="card-icon icon-files"><i class="fas fa-shield-halved"></i></div>
                <div>
                    <h6 class="text-muted mb-0">Files Changed (Today)</h6>
                    <p class="fs-2 fw-bold" id="changed-files">--</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-card-small">
                <div class="card-icon icon-audit"><i class="fas fa-bell"></i></div>
                <div>
                    <h6 class="text-muted mb-0">Active Alerts</h6>
                    <p class="fs-2 fw-bold" id="active-alerts">--</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-4">
            <div class="themed-card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center mb-0">Current CPU Load</h5>
                    <div id="agent-cpu-gauge" class="flex-grow-1"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="themed-card h-100">
                <div class="card-body d-flex flex-column">
                     <h5 class="card-title text-center mb-0">Memory Distribution</h5>
                    <div id="agent-mem-donut" class="flex-grow-1"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="themed-card h-100">
                <div class="card-body d-flex flex-column">
                     <h5 class="card-title text-center mb-0">CPU Usage History (60s)</h5>
                    <div id="agent-cpu-history" class="flex-grow-1"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <div class="col-lg-12">
            <div class="themed-card">
                <div class="card-body">
                    <h5 class="card-title">Recent Activity</h5>
                    <table class="table table-sm table-borderless">
                        <tbody id="recent-events-table-body">
                            <tr><td class="text-muted text-center">Loading recent events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    .themed-card {
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .dark-mode .themed-card { box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .summary-card-small {
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        height: 100%;
    }
    .card-icon { font-size: 1.75rem; min-width: 50px; height: 50px; border-radius: 50%; display: grid; place-items: center; }
    .icon-sessions { background-color: #dcfce7; color: #16a34a; } .icon-commands { background-color: #fffbe5; color: #f59e0b; } .icon-files { background-color: #fee2e2; color: #ef4444; } .icon-audit { background-color: #e5e7eb; color: #4b5563; }
    .dark-mode .icon-sessions { background-color: rgba(74, 222, 128, 0.1); color: #4ade80; } .dark-mode .icon-commands { background-color: rgba(255, 212, 59, 0.1); color: #ffd43b; } .dark-mode .icon-files { background-color: rgba(255, 107, 107, 0.1); color: #ff6b6b; } .dark-mode .icon-audit { background-color: rgba(107, 114, 128, 0.1); color: #6b7280; }
    #last-command { word-break: break-all; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('agent-dashboard-container');
    const agentUUID = container.dataset.agentUuid;
    let allCharts = [];

    // --- CHART INITIALIZATION ---
    function initCharts() {
        const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const baseOptions = { chart: { background: 'transparent', toolbar: { show: false }, animations: { easing: 'easeout', speed: 800 } }, stroke: { width: 2, curve: 'smooth' }, markers: { size: 0 }, grid: { show: false }, theme: { mode: localStorage.getItem('darkMode') === 'enabled' ? 'dark' : 'light' } };
        
        const cpuGauge = new ApexCharts(document.querySelector("#agent-cpu-gauge"), { ...baseOptions, chart: { ...baseOptions.chart, type: 'radialBar', height: 280 }, series: [0], colors: ['var(--primary-color)'], plotOptions: { radialBar: { hollow: { size: '65%' }, dataLabels: { name: { show: false }, value: { offsetY: 10, fontSize: '2rem', show: true, formatter: val => `${val}%`} } } }, labels: ['CPU'] });
        const memDonut = new ApexCharts(document.querySelector("#agent-mem-donut"), { ...baseOptions, chart: { ...baseOptions.chart, type: 'donut', height: 280 }, series: [], labels: ['Used', 'Buff/Cache', 'Free'], colors: ['var(--info-color)', 'var(--warning-color)', 'var(--success-color)'], legend: { position: 'bottom' } });
        const cpuHistory = new ApexCharts(document.querySelector("#agent-cpu-history"), { ...baseOptions, chart: { ...baseOptions.chart, type: 'area', height: 250 }, series: [{ name: "CPU %", data: [] }], colors: ['var(--primary-color)'], tooltip: { x: { format: 'HH:mm:ss' } }, xaxis: { type: 'datetime', range: 60000 }, yaxis: { min: 0, max: 100 } });
        
        allCharts.push(cpuGauge, memDonut, cpuHistory);
        allCharts.forEach(chart => chart.render());
        return { cpuGauge, memDonut, cpuHistory };
    }
    const charts = initCharts();

    // --- DATA FETCHING & UI UPDATING FUNCTIONS ---
    async function updateDashboard() {
        try {
            // Fetch all data in parallel
            const [summaryRes, statsRes, alertsRes] = await Promise.all([
                fetch(`/api/v1/dashboard/summary/${agentUUID}`),
                fetch(`/api/v1/dashboard/system_stats?agent_uuid=${agentUUID}`),
                fetch(`/api/v1/dashboard/alerts`)
            ]);

            // Process Summary Data for cards
            if (summaryRes.ok) {
                const summary = await summaryRes.json();
                $('#active-sessions').text(summary.active_sessions);
                $('#last-command').text(summary.last_command);
                $('#changed-files').text(summary.changed_files_count);
                $('#active-alerts').text(summary.audit_events_count);
            }

            // Process System Stats for charts and status badge
            if (statsRes.ok) {
                const stats = await statsRes.json();
                const totalCpu = parseFloat(stats.cpu_user) + parseFloat(stats.cpu_system);
                charts.cpuGauge.updateSeries([totalCpu.toFixed(1)]);
                charts.memDonut.updateSeries([stats.mem_used, stats.mem_buff_cache, stats.mem_free]);
                let history = charts.cpuHistory.w.config.series[0].data;
                history.push([Date.now(), totalCpu]);
                if (history.length > 60) history.shift();
                charts.cpuHistory.updateSeries([{ data: history }]);
                
                // Update status badge to show 'Active'
                $('#agent-status-badge').removeClass('bg-warning bg-danger').addClass('bg-success');
                $('#agent-status-icon').html('<i class="fas fa-circle-check me-1"></i>');
                $('#agent-status-text').text('Active');
            } else {
                // Handle offline status
                $('#agent-status-badge').removeClass('bg-success bg-warning').addClass('bg-danger');
                $('#agent-status-icon').html('<i class="fas fa-exclamation-triangle me-1"></i>');
                $('#agent-status-text').text('Disconnected');
            }

            // Process Alerts data for recent events table
            if (alertsRes.ok) {
                const alerts = (await alertsRes.json()).data;
                const agentAlerts = alerts.filter(a => a.agent_uuid === agentUUID).slice(0, 5); // Get latest 5
                
                const tableBody = $('#recent-events-table-body');
                tableBody.empty();
                if (agentAlerts.length > 0) {
                    agentAlerts.forEach(alert => {
                        const row = `
                            <tr>
                                <td><span class="badge bg-${alert.status === 'Active' ? 'danger' : 'secondary'}">${alert.status}</span></td>
                                <td><strong>${alert.alert_type}</strong></td>
                                <td><span class="text-primary fw-bold">${alert.value}</span></td>
                                <td class="text-muted"><small>${alert.source}</small></td>
                                <td class="text-muted text-end"><small>${new Date(alert.timestamp).toLocaleString()}</small></td>
                            </tr>`;
                        tableBody.append(row);
                    });
                } else {
                    tableBody.append('<tr><td colspan="5" class="text-muted text-center">No recent alerts for this agent.</td></tr>');
                }
            }

        } catch (error) {
            console.error("Dashboard update failed:", error);
        }
    }

    // --- INITIALIZATION & TIMERS ---
    updateDashboard(); // Initial load
    setInterval(updateDashboard, 5000); // Refresh every 5 seconds for a dynamic feel

    // Handle dark mode changes for charts
    const observer = new MutationObserver(() => {
        const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
        allCharts.forEach(chart => chart.updateOptions({ theme: { mode: theme } }));
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
});
</script>
{% endblock %}