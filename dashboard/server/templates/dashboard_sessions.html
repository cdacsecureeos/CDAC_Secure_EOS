{% extends "base.html" %}

{% block title %}Live Session Dashboard{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h2">üîê Live Session Dashboard</h1>
            <p class="lead text-muted mb-0">Real-time user session and event monitoring.</p>
        </div>
        <div class="d-flex align-items-center">
            <label for="refreshInterval" class="me-2 fw-bold small text-nowrap">Refresh:</label>
            <select id="refreshInterval" class="form-select form-select-sm" style="width: auto;">
                <option value="0">Off</option><option value="10000">10s</option><option value="30000" selected>30s</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 col-lg-3 mb-4"><div class="summary-card" data-filter="" title="Click to show all events"><h6 class="text-muted">Total Events</h6><p class="display-4 fw-bold text-primary" id="total-events-count">0</p></div></div>
        <div class="col-md-6 col-lg-3 mb-4"><div class="summary-card" data-filter="active" title="Click to show active sessions"><h6 class="text-muted">Active Sessions</h6><p class="display-4 fw-bold text-success" id="active-sessions-count">0</p></div></div>
        <div class="col-md-6 col-lg-3 mb-4"><div class="summary-card" data-filter="logout" title="Click to show logouts"><h6 class="text-muted">Logouts (Today)</h6><p class="display-4 fw-bold text-secondary" id="logouts-today-count">0</p></div></div>
        <div class="col-md-6 col-lg-3 mb-4"><div class="summary-card" data-filter=""><h6 class="text-muted">Top Active User</h6><p class="display-6 fw-bold text-info" id="top-user">N/A</p></div></div>
    </div>

    <ul class="nav nav-tabs mb-0" id="sessionTabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabTable" type="button"><i class="fas fa-table me-1"></i> Event Log</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAnalytics" type="button"><i class="fas fa-chart-pie me-1"></i> Analytics</button></li>
    </ul>

    <div class="tab-content" id="sessionTabsContent">
        <div class="tab-pane fade show active" id="tabTable" role="tabpanel"><div class="card"><div class="card-body"><div id="sessions-table-container"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin me-2"></i>Loading Event Data...</div></div></div></div></div>
        <div class="tab-pane fade" id="tabAnalytics" role="tabpanel"><div class="card"><div class="card-body"><div id="analytics-container" class="loading-placeholder"><i class="fas fa-chart-pie me-2"></i>Analytics will load when tab is active.</div></div></div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Page-specific dependencies -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<style>
    body { font-family: 'Poppins', sans-serif; }
    .card { background-color: var(--card-bg-color); border-radius: 12px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
    .summary-card { padding: 1.5rem; text-align: center; cursor: pointer; }
    .summary-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .dark-mode .summary-card:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .nav-tabs .nav-link.active { color: var(--primary-color); background-color: transparent; border-bottom: 3px solid var(--primary-color); }
    .tab-content .card { border-radius: 0 0 12px 12px; border-top: none; }
    .loading-placeholder { min-height: 400px; display: flex; align-items: center; justify-content: center; }
</style>

<script>
$(document).ready(function() {
    let sessionsTable, interval, usersChart, sessionChart;
    let isTableInitialized = false, isChartsInitialized = false;
    let allCharts = [], currentData = [];

    function applyTheme(theme) {
        if(isChartsInitialized){
            const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(); 
            allCharts.forEach(chart => chart.updateOptions({ chart: { foreColor: chartTextColor }, theme: { mode: theme }, tooltip: { theme: theme } }));
        }
    }

    const observer = new MutationObserver(() => applyTheme(document.body.classList.contains('dark-mode') ? 'dark' : 'light'));
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

    function renderEventBadge(data) {
        const badgeMap = { 'login': 'success', 'logout': 'secondary', 'active': 'info' };
        return `<span class="badge bg-${badgeMap[data] || 'light'}">${data || 'N/A'}</span>`;
    }

    function updateUI(data) {
        const activeSessions = data.filter(s => s.event !== 'logout');
        const today = new Date().toISOString().slice(0, 10);
        const logoutsToday = data.filter(s => s.event === 'logout' && s.timestamp && s.timestamp.startsWith(today));
        
        $('#total-events-count').text(data.length);
        $('#active-sessions-count').text(activeSessions.length);
        $('#logouts-today-count').text(logoutsToday.length);
        
        const userCounts = activeSessions.reduce((acc, s) => { acc[s.username] = (acc[s.username] || 0) + 1; return acc; }, {});
        const topUser = Object.keys(userCounts).sort((a,b) => userCounts[b] - userCounts[a])[0] || 'N/A';
        $('#top-user').text(topUser);

        if (isChartsInitialized) {
            const sessionCountsBySessionId = activeSessions.reduce((acc, s) => { acc[s.session_id] = 1; return acc; }, {});
            usersChart.updateOptions({ series: Object.values(userCounts), labels: Object.keys(userCounts) });
            sessionChart.updateOptions({ series: Object.values(sessionCountsBySessionId), labels: Object.keys(sessionCountsBySessionId) });
        }
    }

    function initTable(initialData) {
        if (isTableInitialized) return;
        $('#sessions-table-container').html('<table id="sessionsTable" class="table table-hover table-striped nowrap w-100"><thead><tr><th>Timestamp</th><th>Event</th><th>Username</th><th>Command</th><th>TTY</th><th>From IP</th><th>Login@</th><th>Idle</th><th>Session ID</th></tr></thead></table>');
        sessionsTable = $('#sessionsTable').DataTable({
            data: initialData,
            rowId: 'session_id',
            deferRender: true,
            columns: [
                { data: 'timestamp' }, { data: 'event', render: renderEventBadge }, { data: 'username' }, 
                { data: 'command' }, { data: 'tty' }, { data: 'from_ip' }, 
                { data: 'login_time' }, { data: 'idle' }, { data: 'session_id' }
            ],
            order: [[0, 'desc']], scrollX: true, autoWidth: false, pageLength: 10,
            dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" + "<'row mt-2'<'col-sm-12'B>>",
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
        });
        isTableInitialized = true;
    }

    function initCharts(data) {
        if (isChartsInitialized) return;
        $('#analytics-container').html('<div class="row g-lg-4"><div class="col-lg-6"><div id="users-chart"></div></div><div class="col-lg-6"><div id="session-chart"></div></div></div>');
        
        const activeSessions = data.filter(s => s.event !== 'logout');
        const userCounts = activeSessions.reduce((acc, s) => { acc[s.username] = (acc[s.username] || 0) + 1; return acc; }, {});
        const sessionCounts = activeSessions.reduce((acc, s) => { acc[s.session_id] = 1; return acc; }, {});

        const chartOptions = { chart: { type: 'donut', height: 400, background: 'transparent' }, legend: { position: 'bottom' }, noData: { text: "No active sessions."} };
        usersChart = new ApexCharts(document.querySelector("#users-chart"), {...chartOptions, series: Object.values(userCounts), labels: Object.keys(userCounts), title: { text: 'Active Sessions by User' }});
        sessionChart = new ApexCharts(document.querySelector("#session-chart"), {...chartOptions, series: Object.values(sessionCounts), labels: Object.keys(sessionCounts), title: { text: 'Active Sessions by Session ID' }, legend: { show: false }});
        
        allCharts.push(usersChart, sessionChart);
        usersChart.render();
        sessionChart.render();
        isChartsInitialized = true;
        applyTheme(document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    async function refreshData() {
        try {
            const response = await fetch('/api/v1/sessions');
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const json = await response.json();
            currentData = (json && json.data) ? json.data : [];
            
            if (!isTableInitialized) {
                initTable(currentData);
            } else {
                sessionsTable.clear().rows.add(currentData).draw(false);
            }
            updateUI(currentData);

        } catch (error) { console.error("Error refreshing data:", error); }
    }

    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
        const target = $(e.target).data("bs-target");
        if (target === '#tabTable' && isTableInitialized) {
            sessionsTable.columns.adjust();
        }
        if (target === '#tabAnalytics' && !isChartsInitialized) {
            setTimeout(() => { initCharts(currentData); }, 150);
        }
    });

    $('.summary-card').on('click', function() {
        if (!isTableInitialized) return;
        const filter = $(this).data('filter');
        const searchString = (filter === 'active') ? '^(?!.*logout).*$' : filter;
        sessionsTable.column(1).search(searchString, true, false).draw();
        // Switch to the 'Event Log' tab when a card is clicked
        $('#sessionTabs button[data-bs-target="#tabTable"]').tab('show');
    });

    $('#refreshInterval').on('change', function () { 
        clearInterval(interval); 
        const val = parseInt(this.value); 
        if (val > 0) interval = setInterval(refreshData, val); 
    }).trigger('change');

    refreshData();
});
</script>
{% endblock %}